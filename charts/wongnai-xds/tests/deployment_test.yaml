suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: should create deployment with correct name
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-wongnai-xds

  - it: should use correct image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/wongnai/xds

  - it: should set correct ports
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: grpc
            containerPort: 5000
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 9000
            protocol: TCP

  - it: should apply custom image when set
    set:
      deployment.image: custom/image:v1.0.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom/image:v1.0.0

  - it: should set resources when specified
    set:
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi

  - it: should set node selector when specified
    set:
      nodeSelector:
        kubernetes.io/arch: amd64
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            kubernetes.io/arch: amd64

  - it: should set tolerations when specified
    set:
      tolerations:
        - key: "key1"
          operator: "Equal"
          value: "value1"
          effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "key1"
            operator: "Equal"
            value: "value1"
            effect: "NoSchedule"
